name: BD-700 Daily Digest

on:
  # Run Monday through Friday at 13:00 UTC (8:00 AM EST / 9:00 AM EDT)
  schedule:
    - cron: '0 13 * * 1-5'

  # Keep manual trigger for testing
  workflow_dispatch:

jobs:
  generate-digest:
    runs-on: ubuntu-latest

    # Grant permission to write to the repo (Required for saving sent_history.json)
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Set up Python
        run: uv python install 3.10

      # FIX: Create a virtual environment first, then install packages
      - name: Install dependencies
        run: |
          uv venv
          uv pip install google-generativeai feedparser python-dotenv

      - name: Debug env presence
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          EMAIL_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
        run: |
          echo "GEMINI_API_KEY present: ${GEMINI_API_KEY:+yes}"
          echo "SMTP_PASSWORD present: ${EMAIL_PASSWORD:+yes}"

      - name: Run digest workflow
        env:
          # Map your Repository Secrets to the Env Vars the Python script needs
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          
          # Mapping your existing email secrets to standard names
          EMAIL_SENDER: ${{ secrets.FROM_EMAIL }}
          EMAIL_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          EMAIL_RECIPIENT: ${{ secrets.RECIPIENT_EMAIL }}
        run: |
          # uv run will automatically detect the .venv created above
          uv run python src/main.py

      # Save the history file back to the repo so we don't send duplicates
      - name: Commit and Push History
        run: |
          git config --global user.name "GitHub Actions Bot"
          git config --global user.email "actions@github.com"
          
          # Add the history file if it exists
          git add sent_history.json
          
          # Commit changes. The '|| exit 0' prevents failure if there are no new emails.
          git commit -m "Update sent_history.json [skip ci]" || exit 0
          # Push changes back to the repository
          git push
